<div align="center">

# 📈 MarketBot

[![License: AGPL-3.0](https://img.shields.io/badge/License-AGPL--3.0-blue.svg)](https://www.gnu.org/licenses/agpl-3.0)
[![TypeScript](https://img.shields.io/badge/TypeScript-5.0+-blue.svg)](https://www.typescriptlang.org/)
[![Node.js](https://img.shields.io/badge/Node.js-18+-green.svg)](https://nodejs.org/)

> 🤖 Multi-Agent 市场分析系统 | 支持 Crypto · 股票 · 外汇 | AI 驱动的决策仪表盘

[**功能特性**](#-功能特性) • [**快速开始**](#-快速开始) • [**架构设计**](#-架构设计) • [**配置指南**](#-配置指南)

[English](README.md) | 简体中文

</div>

## ✨ 功能特性

### 🎯 核心功能

- **AI 决策仪表盘** - 一句话核心结论 + 精确买卖点位 + 风险检查清单
- **多 Agent 协作** - 意图解析 → 市场体制 → 风险评估 → 反思综合 → 报告生成
- **浏览器自动化** - 自动搜索新闻、抓取网页进行实时分析
- **多市场支持** - Crypto、A股/港股/美股、外汇及任意可搜索资产
- **多渠道推送** - 支持企业微信、飞书、Telegram、Webhook

### 🛡️ 交易理念内置

- ❌ **严禁追高** - 乖离率 > 5% 自动标记「危险」
- ✅ **趋势交易** - MA5 > MA10 > MA20 多头排列
- 📍 **精确点位** - 入场价、止损价、目标价
- 📋 **检查清单** - 每项条件用 ✅⚠️❌ 标记

### 📊 数据来源

- **行情数据**: Yahoo Finance、Binance（自动切换）
- **新闻搜索**: 浏览器自动化（DuckDuckGo/Bing）
- **AI 分析**: OpenAI、DeepSeek、及其他 OpenAI 兼容 API

## 🎥 演示 / Demo

> **查询**: `marketbot web-analyze "Analyze Google"`  
> **结果**: 自动生成全英文报告 (英文查询自动触发英文模式)

```markdown
# 📄 AI Stock Analysis Report
---
📅 **2026-01-31T14:15:00.000Z** | *AI Stock Trading Snapshot*

💵 **Current Price**: 175.50 USD | GOOGL | Yahoo Finance @ 14:15

## 🟦 Core Conclusion
| Direction & Confidence | Params | Rationale |
|:---|:---|:---|
| 🟢 **LONG ↑** | Entry: 172.00 | Uptrend |
| ⭐⭐⭐⭐☆ (85/100) | TP: 195.00 | Bullish |
| **Uptrend** | SL: 165.00 | Positive Crossover |

## 🟨 Market & Status
| Regime | Status |
|:---|:---|
| Regime: Risk-On 📈 | Trend: Uptrend |
| Volatility: Medium | Structure: Bullish |

## 🟩 Key Drivers
### 📊 Technicals
- MA: Bullish
- MACD: Positive Crossover
- RSI: Neutral (55)

### 📰 Events/Fundamentals
- Dominant market share in Search (>90%)
- Aggressive AI integration with Gemini models
- Cloud revenue growing +25% YoY
- Facing antitrust scrutiny in EU and US

## 🟥 Risks & Invalidation
### ⚠️ Main Risks
- Regulatory/Antitrust fines
- AI competition (OpenAI/Microsoft)
---
> ⚠️ **Disclaimer**: Generated by AI for research only. Not financial advice.
```

## 🚀 快速开始

### 1. 安装

```bash
git clone https://github.com/EthanAlgoX/MarketBot.git
cd MarketBot
npm install
npm run build
```

### 2. 配置 API Key

**支持 OpenAI, DeepSeek, Google Gemini, Claude, 通义千问, Moonshot, Ollama**

详细配置请参考 [配置指南](#-配置指南) 章节。

**示例：OpenAI (默认)**

```bash
# 方式一：环境变量
export OPENAI_API_KEY="sk-..."

# 方式二：.env 文件
echo 'OPENAI_API_KEY=sk-...' > .env
```

### 3. 运行分析

```bash
# 分析股票
node dist/index.js web-analyze "GOOGL 股票分析"

# 分析加密货币
node dist/index.js web-analyze "BTC 今日走势"

# 资产模式（自动搜索价格、新闻、情绪）
node dist/index.js web-analyze --asset ETH

# 标准分析 (仅市场数据)
node dist/index.js analyze "分析苹果"

# 无 API Key 测试 (Mock 模式)
node dist/index.js analyze "分析 BTC" --mock
```

### 3b. GUI / TUI

```bash
# 启动 Web GUI（自动打开浏览器）
node dist/index.js gui

# 启动终端交互界面
node dist/index.js tui
```

TUI 指令示例：`/help`、`/exit`、`/history`、`/use <n>`、`/json on|off`、`/mode <mock|auto|api|scrape|none>`、`/search on|off`、`/scrape on|off`、`/agent <id|clear>`、`/session <key|clear>`。

### 4. 完成

首次运行会自动下载 Chromium 浏览器用于网页搜索。

## 📱 输出效果

### 决策仪表盘

```
📄 AI 股票分析报告
---
📅 2026-01-31 | AI Stock Trading Snapshot

## 🟦 核心结论

| 方向 & 置信度 | 交易参数 | 核心逻辑 |
|:---|:---|:---|
| 🟢 LONG ↑ | 入场: $338.00 | 上升趋势 |
| ⭐⭐⭐⭐☆ (80/100) | 止盈: $350.00 | 多头排列 |
| **趋势向上** | 止损: $320.00 | MACD 金叉 |

## 🟩 关键依据

### 🧠 Agentic Agent 模式 (新)

Agentic 模式允许 LLM 自主决定使用哪些工具以及如何分析数据，而不是遵循固定的流水线。

```bash
# 启用 Agentic 模式
node dist/index.js analyze "深度分析 NVIDIA" --agentic

# 查看详细思考过程
node dist/index.js analyze "对比 BTC 和 ETH" --agentic --verbose
```

### 📊 技术面

- 均线: 多头排列
- MACD: 金叉
- RSI: 正常区间

### 📰 事件/基本面

- 财报将于 2/4 发布
- 分析师评级: Strong Buy

## 🟥 风险 & 失效条件

- 市场波动风险
- 日线收盘跌破 $320 失效

---
⚠️ 免责声明: 本报告由 AI 生成，仅供研究参考，不构成投资建议。

```

## 🏗️ 架构设计

```mermaid
graph TD
    subgraph MarketBot
        direction TB
        
        subgraph CorePipeline["核心流水线 (Core Pipeline)"]
            Intent["意图 (Intent)"] --> Data["数据 (Data)"]
            Data --> Interpret["解读 (Interpret)"]
            Interpret --> Regime["体制 (Regime)"]
            Regime --> Risk["风险 (Risk)"]
            Risk --> Reflect["反思 (Reflect)"]
            Reflect --> Report["报告 (Report)"]
        end

        subgraph SpecializedAgents["专业 Agent 模块"]
            IP["意图解析 (IntentParser)"]
            MR["市场体制 (MarketRegime)"]
            RA["风险评估 (RiskAssessment)"]
            Ref["反思综合 (Reflection)"]
            RG["报告生成 (ReportGenerator)"]
            WA["网页分析 (WebDataAnalyzer)"]
        end
    end
````

### Agent 模块

| Agent | 职责 | 输出 |
|-------|------|------|
| **IntentParser** | 解析用户查询意图 | asset, market, timeframes |
| **MarketDataInterpreter** | 解读市场数据 | structure, volatility, momentum |
| **MarketRegime** | 识别市场体制 | regime, strategy, confidence |
| **RiskAssessment** | 评估交易风险 | risk_level, position_size |
| **Reflection** | 综合分析、识别盲点 | confidence, alternatives |
| **ReportGenerator** | 生成专业报告 | Markdown Report |
| **WebDataAnalyzer** | 网页搜索+分析 | 搜索结果、分析报告 |

## ⚙️ 配置指南

### 🔐 OAuth 认证 (Bring Your Own Identity)

MarketBot 支持通过 OAuth 认证直接使用您的 Google Gemini 或 OpenAI 账户。

```bash
# 登录 Google (Gemini)
npx tsx src/index.js auth login --provider google

# 登录 OpenAI (Codex/ChatGPT 订阅)
npx tsx src/index.js auth login --provider openai-codex
```

认证成功后，MarketBot 会**自动优先使用**您的 OAuth 凭证，覆盖本地 `marketbot.json` 或环境变量中的配置。

**管理认证状态:**

```bash
# 查看状态
npx tsx src/index.js auth status --provider all

# 登出
npx tsx src/index.js auth logout --provider google
```

### 🤖 AI 模型配置 (免配置文件)

MarketBot 支持通过环境变量直接配置模型，**无需创建 `marketbot.json`！**

**方案 1: Google Gemini (免费推荐)**

```bash
export GEMINI_API_KEY="AIzaSy..."
```

**方案 2: OpenAI / 兼容接口 (DeepSeek/通义千问等)**

```bash
export OPENAI_API_KEY="sk-..."
export OPENAI_BASE_URL="https://api.deepseek.com/v1"  # 可选
export OPENAI_MODEL="deepseek-chat"                   # 可选
```

| 环境变量名 | 说明 | 必填 |
|------------|------|:----:|
| `GEMINI_API_KEY` | Google Gemini API Key | 可选* |
| `OPENAI_API_KEY` | OpenAI / 兼容 API Key | 可选* |
| `OPENAI_BASE_URL` | 自定义接口地址 (如 DeepSeek) | 可选 |
| `OPENAI_MODEL` | 自定义模型名称 (默认: gpt-4o-mini) | 可选 |

> \* 注: `GEMINI_API_KEY` 和 `OPENAI_API_KEY` 至少需配置一个。

<details>
<summary><b>进阶: 使用 marketbot.json 配置文件</b></summary>

如果你需要复杂的配置，仍然可以使用 `marketbot.json`。

```json
{
  "llm": {
    "provider": "openai-compatible",
    "apiKey": "sk-...",
    "model": "deepseek-chat",
    "baseUrl": "https://api.deepseek.com/v1"
  }
}
```

</details>

### 浏览器配置

```json
{
  "web": {
    "search": {
      "provider": "browser",
      "maxResults": 5,
      "headless": false
    }
  }
}
```

> 设置 `headless: true` 在后台运行浏览器

### 🔔 通知渠道配置

支持通过环境变量或 `.env` 文件配置，可同时启用多个渠道。

| 环境变量名 | 说明 | 必填 |
|------------|------|:----:|
| `WECHAT_WEBHOOK_URL` | 企业微信 Webhook URL | 可选 |
| `FEISHU_WEBHOOK_URL` | 飞书 Webhook URL | 可选 |
| `TELEGRAM_BOT_TOKEN` | Telegram Bot Token (@BotFather) | 可选 |
| `TELEGRAM_CHAT_ID` | Telegram Chat ID | 可选 |
| `PUSHPLUS_TOKEN` | PushPlus Token (<http://www.pushplus.plus>) | 可选 |
| `CUSTOM_WEBHOOK_URL` | 自定义 Webhook URL | 可选 |
| `CUSTOM_WEBHOOK_BEARER_TOKEN` | 自定义 Webhook Bearer Token | 可选 |

## 🖥️ HTTP API

```bash
# 启动服务器
node dist/index.js server --port 8787

# 健康检查
curl http://127.0.0.1:8787/health

# 分析请求
curl -X POST http://127.0.0.1:8787/analyze \
  -H "Content-Type: application/json" \
  -d '{"query":"Analyze BTC"}'
```

## 📁 项目结构

MarketBot/
├── src/
│   ├── agents/          # 专业 Agent (7个)
│   ├── cli/             # CLI 命令与入口
│   ├── config/          # 配置与默认模板
│   ├── core/            # 流水线、LLM 接口、Prompts
│   ├── pipeline/        # 股票分析流水线
│   ├── server/          # HTTP 服务器 & Gateway
│   ├── services/        # 统一服务层
│   ├── skills/          # 技能系统 (内置于 /defaults)
│   ├── tools/           # 工具调度
│   └── web/             # 浏览器搜索/抓取
├── marketbot.json       # 配置文件
└── package.json

## 🗺️ 开发路线

### 🔔 通知渠道

- [x] 企业微信机器人
- [x] 飞书机器人
- [x] Telegram Bot
- [x] 自定义 Webhook
- [ ] 邮件通知

### 🤖 AI 模型

- [x] OpenAI GPT-4/GPT-4o
- [x] DeepSeek
- [x] 通义千问
- [ ] 本地模型 (Ollama)

## 架构设计

MarketBot 基于 **Agentic Architecture (代理架构)** 构建，旨在实现自主决策，其设计理念与 [Moltbot](https://github.com/moltbot/moltbot) 保持一致。

- **Agent Core (核心代理)**: 使用自主循环 (`src/core/agentLoop.ts`) 来分析用户意图、规划工具使用并执行步骤。
- **Tools System (工具系统)**: 定义了一等公民工具 (`src/tools`)，代理可以自主选择和调用（例如 `market_fetch`, `indicators_compute`）。
- **Flexible Providers (灵活的提供商)**: 支持可插拔的 LLM 后端（OpenAI 兼容, Mock）。
- **Multi-Interface (多接口)**: 支持 CLI 和 Web 仪表板访问。

> **注意**: 就像 Moltbot 一样，MarketBot 被设计为在行动前进行“思考”，自主决定满足您市场分析需求的最佳方式。

### 📊 数据源

- [x] Yahoo Finance
- [x] Binance
- [x] 浏览器搜索
- [ ] Tushare Pro
- [ ] AkShare

### 🎯 功能增强

- [x] 决策仪表盘
- [x] 多 Agent 协作
- [x] 一页式报告
- [x] HTTP API
- [ ] 历史分析回测
- [ ] GitHub Actions 定时运行

## ⚠️ 免责声明

本项目仅供学习和研究使用，不构成任何投资建议。股市有风险，投资需谨慎。作者不对使用本项目产生的任何损失负责。

## 📄 License

[AGPL-3.0 License](LICENSE) © 2026 EthanAlgoX

---

<div align="center">

**如果觉得有用，请给个 ⭐ Star 支持一下！**

</div>
